<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸƒ AI ëª¨ì…˜ ë¶„ì„ | Play Lab</title>
  
  <!-- í°íŠ¸ -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;500;700;900&display=swap" rel="stylesheet">
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f8fafc;
      color: #1e293b;
      display: block !important;
    }

    /* Header */
    .site-header {
      position: sticky;
      top: 0;
      width: 100%;
      z-index: 9999;
      background: #ffffff;
      border-bottom: 1px solid #e2e8f0;
      padding: 1rem 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }
    .header-content {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-logo {
      font-size: 1.25rem;
      font-weight: 700;
      color: #334155;
      text-decoration: none;
    }
    .header-logo .dot { color: #3b82f6; }
    .header-logo .info { color: #64748b; font-weight: 300; }
    .header-nav { display: flex; gap: 1.5rem; }
    .header-nav a {
      font-size: 0.95rem;
      color: #64748b;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }
    .header-nav a:hover { color: #3b82f6; }

    /* Main Container */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }
    
    /* Hero */
    .hero {
      text-align: center;
      margin-bottom: 2rem;
    }
    .hero h1 {
      font-size: 2rem;
      font-weight: 900;
      color: #334155;
      margin-bottom: 0.5rem;
    }
    .hero p {
      font-size: 1rem;
      color: #64748b;
      line-height: 1.5;
    }

    /* ì—…ë¡œë“œ ë°•ìŠ¤ */
    .upload-box {
      background: white;
      border: 2px dashed #cbd5e1;
      border-radius: 20px;
      padding: 3rem 2rem;
      text-align: center;
      margin-bottom: 2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-box:hover {
      border-color: #3b82f6;
      background: #f8fafc;
    }
    .upload-box.active {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .upload-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .upload-text {
      font-size: 1.1rem;
      font-weight: 700;
      color: #334155;
      margin-bottom: 0.5rem;
    }
    .upload-subtext {
      font-size: 0.9rem;
      color: #64748b;
    }
    #fileInput {
      display: none;
    }

    /* ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ */
    .video-wrapper {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto 2rem;
      background: #000;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
    }
    .video-wrapper.show {
      display: block;
    }
    #videoPlayer {
      width: 100%;
      height: auto;
      display: block;
    }
    #output_canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
    .controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
    }
    .btn {
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .btn-analyze {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 8px 16px -4px rgba(37, 99, 235, 0.3);
    }
    .btn-analyze:hover { transform: translateY(-2px); }
    .btn-analyze:disabled {
      background: #cbd5e1;
      cursor: not-allowed;
      box-shadow: none;
    }
    .btn-reset {
      background: #64748b;
      color: white;
    }
    .btn-reset:hover { background: #475569; }

    /* ë¶„ì„ ê²°ê³¼ */
    .result-box {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
      margin-bottom: 2rem;
      display: none;
    }
    .result-box.show {
      display: block;
    }
    .result-box h3 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 1rem;
    }
    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f1f5f9;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .result-label {
      color: #64748b;
      font-weight: 500;
    }
    .result-value {
      font-weight: 700;
      color: #0f172a;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #2563eb);
      transition: width 0.3s;
    }

    /* ë¡œë”© ìƒíƒœ */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #64748b;
    }
    .spinner {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .container { padding: 1.5rem 1rem; }
      .hero h1 { font-size: 1.5rem; }
      .controls { flex-direction: column; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>

<!-- Header -->
<header class="site-header">
  <div class="header-content">
    <a href="https://namane.info" class="header-logo">
      namane<span class="dot">.</span><span class="info">info</span>
    </a>
    <nav class="header-nav">
      <a href="/">í™ˆ</a>
      <a href="/calc">ì»¨ë””ì…˜</a>
      <a href="/motion">ëª¨ì…˜</a>
    </nav>
  </div>
</header>

<!-- Main Content -->
<div class="container">
  
  <div class="hero">
    <h1>ğŸƒ AI ëª¨ì…˜ ë¶„ì„</h1>
    <p>5~10ì´ˆ ì˜ìƒì„ ì—…ë¡œë“œí•˜ë©´ ìì„¸ì™€ ë°¸ëŸ°ìŠ¤ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>
  </div>

  <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
  <div class="upload-box" id="uploadBox">
    <div class="upload-icon">ğŸ“¹</div>
    <div class="upload-text">ë™ì˜ìƒ ì„ íƒí•˜ê¸°</div>
    <div class="upload-subtext">MP4, MOV íŒŒì¼ ì§€ì› (ìµœëŒ€ 30ì´ˆ)</div>
    <input type="file" id="fileInput" accept="video/*">
  </div>

  <!-- ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ + ìº”ë²„ìŠ¤ -->
  <div class="video-wrapper" id="videoWrapper">
    <video id="videoPlayer" playsinline muted loop></video>
    anvas id="output_canvas"></canvas>
  </div>

  <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
  <div class="controls">
    <button id="analyze-btn" class="btn btn-analyze" disabled>ğŸ” ë¶„ì„ ì‹œì‘</button>
    <button id="reset-btn" class="btn btn-reset" style="display:none;">ğŸ”„ ë‹¤ì‹œ ì„ íƒ</button>
  </div>

  <!-- ë¡œë”© ìƒíƒœ -->
  <div id="loading" class="loading" style="display:none;">
    <div class="spinner"></div>
    <p>ì˜ìƒì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
  </div>

  <!-- ë¶„ì„ ê²°ê³¼ -->
  <div id="resultBox" class="result-box">
    <h3>ğŸ“Š ë¶„ì„ ê²°ê³¼</h3>
    
    <div class="result-item">
      <span class="result-label">ì¢Œìš° ë°¸ëŸ°ìŠ¤</span>
      <span class="result-value" id="balance">--</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="balanceBar" style="width: 0%;"></div>
    </div>

    <div class="result-item">
      <span class="result-label">ë¬´ë¦ ê°ë„ (í‰ê· )</span>
      <span class="result-value" id="kneeAngle">--</span>
    </div>

    <div class="result-item">
      <span class="result-label">ìƒì²´ ê¸°ìš¸ê¸°</span>
      <span class="result-value" id="bodyTilt">--</span>
    </div>

    <div class="result-item">
      <span class="result-label">ì°©ì§€ ì•ˆì •ì„±</span>
      <span class="result-value" id="stability">--</span>
    </div>
  </div>

</div>

<!-- MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

<!-- ëª¨ì…˜ ë¶„ì„ ë¡œì§ -->
<script>
  const uploadBox = document.getElementById('uploadBox');
  const fileInput = document.getElementById('fileInput');
  const videoWrapper = document.getElementById('videoWrapper');
  const videoPlayer = document.getElementById('videoPlayer');
  const canvas = document.getElementById('output_canvas');
  const ctx = canvas.getContext('2d');
  const analyzeBtn = document.getElementById('analyze-btn');
  const resetBtn = document.getElementById('reset-btn');
  const loading = document.getElementById('loading');
  const resultBox = document.getElementById('resultBox');

  let selectedFile = null;
  let poseResults = [];

  // ì—…ë¡œë“œ ë°•ìŠ¤ í´ë¦­ â†’ íŒŒì¼ ì„ íƒ
  uploadBox.addEventListener('click', () => {
    fileInput.click();
  });

  // íŒŒì¼ ì„ íƒ ì‹œ
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    selectedFile = file;
    const url = URL.createObjectURL(file);
    
    videoPlayer.src = url;
    videoPlayer.load();
    
    // UI
    // UI ì—…ë°ì´íŠ¸
    uploadBox.classList.add('active');
    uploadBox.querySelector('.upload-text').textContent = 'âœ… ì˜ìƒ ì„ íƒë¨';
    uploadBox.querySelector('.upload-subtext').textContent = file.name;
    
    videoWrapper.classList.add('show');
    analyzeBtn.disabled = false;
    resetBtn.style.display = 'inline-block';
  });

  // MediaPipe Pose ì„¤ì •
  const pose = new Pose({
    locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
    }
  });

  pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: false,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  pose.onResults(onPoseResults);

  // Pose ê²°ê³¼ ì²˜ë¦¬
  function onPoseResults(results) {
    // ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

    if (results.poseLandmarks) {
      // ê´€ì ˆ ì—°ê²°ì„  (ë…¹ìƒ‰)
      drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, {
        color: '#00FF00',
        lineWidth: 4
      });
      
      // ê´€ì ˆ ì  (ë¹¨ê°„ìƒ‰)
      drawLandmarks(ctx, results.poseLandmarks, {
        color: '#FF0000',
        lineWidth: 2,
        radius: 5
      });

      // ë¶„ì„ ë°ì´í„° ì €ì¥
      poseResults.push({
        landmarks: results.poseLandmarks,
        timestamp: videoPlayer.currentTime
      });
    }

    ctx.restore();
  }

  // ë¶„ì„ ì‹œì‘ ë²„íŠ¼
  analyzeBtn.addEventListener('click', async () => {
    analyzeBtn.disabled = true;
    loading.style.display = 'block';
    resultBox.classList.remove('show');
    poseResults = []; // ì´ˆê¸°í™”

    // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
    canvas.width = videoPlayer.videoWidth;
    canvas.height = videoPlayer.videoHeight;

    // ë¹„ë””ì˜¤ ì¬ìƒ ë° í”„ë ˆì„ë³„ ë¶„ì„
    videoPlayer.currentTime = 0;
    videoPlayer.play();

    const fps = 10; // ì´ˆë‹¹ 10í”„ë ˆì„ ë¶„ì„
    const interval = 1000 / fps;

    const analyzeInterval = setInterval(async () => {
      if (videoPlayer.ended || videoPlayer.paused) {
        clearInterval(analyzeInterval);
        
        // ë¶„ì„ ì™„ë£Œ â†’ ê²°ê³¼ ê³„ì‚°
        calculateResults();
        loading.style.display = 'none';
        resultBox.classList.add('show');
        analyzeBtn.disabled = false;
        return;
      }

      // MediaPipeì— í”„ë ˆì„ ì „ì†¡
      await pose.send({ image: videoPlayer });
    }, interval);
  });

  // ë‹¤ì‹œ ì„ íƒ ë²„íŠ¼
  resetBtn.addEventListener('click', () => {
    location.reload();
  });

  // ë¶„ì„ ê²°ê³¼ ê³„ì‚°
  function calculateResults() {
    if (poseResults.length === 0) {
      alert('ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜ìƒì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    // 1. ì¢Œìš° ë°¸ëŸ°ìŠ¤ ê³„ì‚° (ì™¼ë°œ vs ì˜¤ë¥¸ë°œ ì²´ì¤‘ ë¶„í¬)
    let leftWeight = 0;
    let rightWeight = 0;

    poseResults.forEach(frame => {
      const landmarks = frame.landmarks;
      
      // ì™¼ìª½ ë°œëª©(27) vs ì˜¤ë¥¸ìª½ ë°œëª©(28)ì˜ y ì¢Œí‘œ ë¹„êµ
      const leftAnkle = landmarks[27];
      const rightAnkle = landmarks[28];
      
      if (leftAnkle && rightAnkle) {
        // yê°’ì´ ë‚®ì„ìˆ˜ë¡ ë” ë†’ì´ ìˆìŒ (ì²´ì¤‘ì´ ëœ ì‹¤ë¦¼)
        if (leftAnkle.y > rightAnkle.y) {
          leftWeight++;
        } else {
          rightWeight++;
        }
      }
    });

    const totalFrames = poseResults.length;
    const balanceScore = Math.round((Math.min(leftWeight, rightWeight) / totalFrames) * 100);
    
    document.getElementById('balance').textContent = `${balanceScore}ì `;
    document.getElementById('balanceBar').style.width = `${balanceScore}%`;

    // 2. ë¬´ë¦ ê°ë„ ê³„ì‚° (í‰ê· )
    let kneeAngles = [];
    
    poseResults.forEach(frame => {
      const landmarks = frame.landmarks;
      
      // ì™¼ìª½ ë¬´ë¦ ê°ë„ (í—ˆë²…ì§€-ë¬´ë¦-ì¢…ì•„ë¦¬)
      const leftHip = landmarks[23];
      const leftKnee = landmarks[25];
      const leftAnkle = landmarks[27];
      
      if (leftHip && leftKnee && leftAnkle) {
        const angle = calculateAngle(leftHip, leftKnee, leftAnkle);
        kneeAngles.push(angle);
      }
    });

    const avgKneeAngle = kneeAngles.length > 0 
      ? Math.round(kneeAngles.reduce((a, b) => a + b, 0) / kneeAngles.length)
      : 0;
    
    document.getElementById('kneeAngle').textContent = `${avgKneeAngle}Â°`;

    // 3. ìƒì²´ ê¸°ìš¸ê¸° (ì–´ê¹¨-ì—‰ë©ì´ ê°ë„)
    const firstFrame = poseResults[0]?.landmarks;
    if (firstFrame) {
      const leftShoulder = firstFrame[11];
      const leftHip = firstFrame[23];
      
      if (leftShoulder && leftHip) {
        const tilt = Math.abs(leftShoulder.x - leftHip.x) * 100;
        const tiltScore = tilt < 5 ? 'ìš°ìˆ˜' : tilt < 10 ? 'ë³´í†µ' : 'ì£¼ì˜';
        document.getElementById('bodyTilt').textContent = tiltScore;
      }
    }

    // 4. ì°©ì§€ ì•ˆì •ì„± (ë°œëª© yì¢Œí‘œ ë³€í™”ëŸ‰)
    let ankleMovement = [];
    
    for (let i = 1; i < poseResults.length; i++) {
      const prev = poseResults[i - 1].landmarks[27]; // ì™¼ìª½ ë°œëª©
      const curr = poseResults[i].landmarks[27];
      
      if (prev && curr) {
        const movement = Math.abs(curr.y - prev.y);
        ankleMovement.push(movement);
      }
    }

    const avgMovement = ankleMovement.length > 0
      ? ankleMovement.reduce((a, b) => a + b, 0) / ankleMovement.length
      : 0;
    
    const stabilityScore = avgMovement < 0.02 ? 'ì•ˆì •ì ' : avgMovement < 0.05 ? 'ë³´í†µ' : 'ë¶ˆì•ˆì •';
    document.getElementById('stability').textContent = stabilityScore;
  }

  // ê°ë„ ê³„ì‚° í•¨ìˆ˜ (3ì  ê¸°ì¤€)
  function calculateAngle(a, b, c) {
    const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
    let angle = Math.abs(radians * 180.0 / Math.PI);
    
    if (angle > 180.0) {
      angle = 360 - angle;
    }
    
    return angle;
  }
</script>

</body>
</html>
